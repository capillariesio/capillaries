# S3 data access

[Integration tests suite](./testing.md#integration-tests) contains tests that use data and config files stored in S3. [k8s POC](../test/k8s/README.md) also uses S3 files. You have to perform some AWS setup steps to make S3 integration tests and k8s POC work.

## Bucket

Create capillaries-testbucket (this name may be taken already, so you may be forced to use some other name). In Permissions tab, turn "Block all public access" on.

Before running tests, make sure you have this environment variable is set:
```
export CAPILLARIES_AWS_TESTBUCKET=capillaries-testbucket
```

### IAM user

daemon/webapi/toolbelt running in our Docker/k8s tests will this IAM user credentials and access S3 capillaries-testbucket.

Create group GroupAccessCapillariesTestbucket, in Permissions Tab, attach PolicyAccessCapillariesTestbucket policy to it.

Create user UserAccessCapillariesTestbucket, add it to GroupAccessCapillariesTestbucket.

Create access key for it, save it to ~/UserAccessCapillariesTestbucket.rc:
```
export AWS_ACCESS_KEY_ID=AK...
export AWS_SECRET_ACCESS_KEY=...
export AWS_DEFAULT_REGION=us-east-1
```

Now, everytime you have to run Capillaries test Docker setup or k8s POC, make sure you run this first:

```
source ~/UserAccessCapillariesTestbucket.rc
```

## Bucket permissions

In the bucket's Permissions tab, use bucket policy like this one:

{
	"Version": "2012-10-17",
	"Statement": [
		{
			"Effect": "Allow",
			"Principal": {
				"AWS": "arn:aws:iam::<your_aws_acount>:user/UserAccessCapillariesTestbucket"
			},
			"Action": "s3:ListBucket",
			"Resource": "arn:aws:s3:::capillaries-testbucket"
		},
		{
			"Effect": "Allow",
			"Principal": {
				"AWS": "arn:aws:iam::<your_aws_acount>:user/UserAccessCapillariesTestbucket"
			},
			"Action": [
				"s3:DeleteObject",
				"s3:GetObject",
				"s3:PutObject"
			],
			"Resource": "arn:aws:s3:::capillaries-testbucket/*"
		}
	]
}

